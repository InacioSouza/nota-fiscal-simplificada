<div class="lista__notas">
    <div class="grid__notas">
        <dx-data-grid #listaNota
                      [dataSource]="notas"
                      keyExpr="id"
                      upda
                      [showBorders]="true"
                      [columnAutoWidth]="true"
                      (onInitNewRow)="onInitNewRowNotas($event)"
                      [focusedRowEnabled]="true">

            <dxo-filter-row [visible]="true"></dxo-filter-row>
            <dxo-paging [pageSize]="10"></dxo-paging>
            <dxo-pager [visible]="true" [showPageSizeSelector]="true" [allowedPageSizes]="[10, 20, 30]"></dxo-pager>

            <dxo-editing
              width="200"
              mode="popup"
              [allowAdding]="true"
              [allowUpdating]="true"
              [allowDeleting]="true">

                <dxo-form [colCount]="2">
                  <dxi-item dataField="id" ></dxi-item>
                  <dxi-item dataField="numero" ></dxi-item>
                  <dxi-item dataField="data_emissao" ></dxi-item>
                  <dxi-item dataField="cliente.nome" ></dxi-item>
                  <dxi-item dataField="valorTotal" ></dxi-item>
                  <dxi-item itemType="empty"></dxi-item>
                  <dxi-item dataField="itens" [colSpan]="2"></dxi-item>
                </dxo-form>

            </dxo-editing>

            <dxo-master-detail [enabled]="true" template="detail"></dxo-master-detail>

            <dxi-column dataField="id" caption="Id" alignment="left" width="220" [allowEditing]="false"></dxi-column>
            <dxi-column dataField="numero" caption="número" alignment="left" width="220" [allowEditing]="false"></dxi-column>
            <dxi-column dataField="data_emissao" caption="Data de Emissão" alignment="left" width="220" dataType="date"></dxi-column>
            <dxi-column dataField="cliente.nome" caption="Cliente" alignment="left" width="220" >
                <dxo-lookup [dataSource]="clientes" displayExpr="nome" valueExpr="nome"></dxo-lookup>
            </dxi-column>
            <dxi-column dataField="valorTotal" caption="Valor Total" alignment="left" width="220" [allowEditing]="false"editCellTemplate="valorNota"></dxi-column>
            <dxi-column dataField="itens" [visible]="false" editCellTemplate="itensEditCellTemplate"></dxi-column>

          <div *dxTemplate="let valorNota of 'valorNota'">
            <dx-number-box
              [value]="valorNota.value"
              [readOnly]="true"
              format="R$ #,##0.##"
              currency="BRL">
            </dx-number-box>
          </div>

          <div *dxTemplate="let data of 'itensEditCellTemplate'">
            <dx-data-grid #dataItens
                          [dataSource]="data.value"
                          [showBorders]="true"
                          [columnAutoWidth]="true"
                          [focusedRowEnabled]="true"
                          [focusedRowIndex]="0">

              <dxo-editing width="200" mode="row"
                           [allowUpdating]="true"
                           [allowDeleting]="true"
                           [allowAdding]="true">

              </dxo-editing>

              <dxi-column dataField="id" caption="Id" alignment="left" width="220" [allowEditing]="false"></dxi-column>
              <dxi-column dataField="produto.nome" caption="Produto" alignment="left" width="220" editCellTemplate="produtoItemEditCellTemplate"></dxi-column>
              <dxi-column dataField="produto.preco" caption="Preço unitário" alignment="left" width="220" [allowEditing]="false" [format]=" {type: 'currency', currency: 'BRL' }" >
                <dxi-validation-rule type="required" message="O preço é obrigatório"></dxi-validation-rule>
              </dxi-column>
              <dxi-column dataField="quantidade" caption="Quantidade" alignment="left" width="220" editCellTemplate="qtdProdutoEditCellTemplate">
                <dxi-validation-rule type="required" message="Digite a quantidade do produto"></dxi-validation-rule>
              </dxi-column>
              <dxi-column dataField="valorTotal" caption="Valor Total" alignment="left" width="220" [allowEditing]="false" [format]=" {type: 'currency', currency: 'BRL' }" [allowEditing]="true" editCellTemplate="valorTotItemEditCellTemplate">
                <dxi-validation-rule type="required" message="O valor total é obrigatório"></dxi-validation-rule>
              </dxi-column>


              <div *dxTemplate="let selectPdt of 'produtoItemEditCellTemplate'">
                <dx-select-box [items]="produtos" displayExpr="nome" placeholder="Selecione um produto"
                               [(value)]="produtoSelecionado" [searchEnabled]="true"
                               (onValueChanged)="vinculaPdtData(selectPdt.row.data, $event, selectPdt)"></dx-select-box>
              </div>

              <div *dxTemplate="let qtd of 'qtdProdutoEditCellTemplate'">
                <dx-number-box [(value)]="qtd.value" format="#" [min]="1"
                               (onValueChanged)="vinculaQtdData(qtd.row.data, $event, qtd)"></dx-number-box>
              </div>

              <div *dxTemplate="let valorTot of 'valorTotItemEditCellTemplate'">
                <dx-number-box [value]="valorTot.value" [readOnly]="true" format="R$ #,##0.##"
                               currency="BRL"></dx-number-box>
              </div>

            </dx-data-grid>

          </div>



        </dx-data-grid>

<!--
        <dx-popup [visible]="exibePopupNota" title="Cadastro de INota" width="80%" height="700" [dragEnabled]="false"
            [closeOnOutsideClick]="true" [showCloseButton]="true" (onHiding)="fechaPopup()">
            <app-cadastra-nota (idNotaCadastrada)="focoNotaCadastrada($event)"></app-cadastra-nota>
        </dx-popup>
-->
    </div>
</div>
